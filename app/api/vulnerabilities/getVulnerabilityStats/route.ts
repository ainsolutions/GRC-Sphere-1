import { NextResponse } from "next/server";
import { withContext } from "@/lib/HttpContext";

//getVulnerabilityStats
export const GET = withContext(async ({ tenantDb }) => {
  const result = await tenantDb `
    SELECT 
      COUNT(*) as total,
      COUNT(CASE WHEN remediation_status = 'Open' THEN 1 END) as open,
      COUNT(CASE WHEN remediation_status = 'In Progress' THEN 1 END) as in_progress,
      COUNT(CASE WHEN remediation_status = 'Resolved' THEN 1 END) as resolved,
      COUNT(CASE WHEN severity = 'Critical' THEN 1 END) as critical,
      COUNT(CASE WHEN severity = 'High' THEN 1 END) as high,
      COUNT(CASE WHEN severity = 'Medium' THEN 1 END) as medium,
      COUNT(CASE WHEN severity = 'Low' THEN 1 END) as low,
      COUNT(CASE WHEN remediation_due_date < NOW() AND remediation_status != 'Resolved' THEN 1 END) as overdue
    FROM vulnerabilities
  ` as Record<string, any>[];
  return NextResponse.json({ success: true, data: result[0] });
});
